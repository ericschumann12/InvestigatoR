---
title: "Vignette Title"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

#' @title Return Prediction Mapping Function (Helper)
#'
#' @description
#' This helper function maps a specified prediction model function over a series of training and prediction intervals, as defined by the `indices` list. It subsets the data into training and test sets for each interval, applies the model function, and generates predictions.
#'
#' @param t Integer, index of the current iteration.
#' @param data_subset Tibble, subset of the data containing `stock_id`, `date`, `return_label`, and `features`.
#' @param indices List, list of training and prediction indices, typically generated by the `select_dates_by_offset` function.
#' @param model_function Character, name of the prediction (model) function to be used.
#' @param model_config List, configuration for the model, containing model-specific parameters.
#'
#' @return Tibble containing `stock_id`, `date`, and the predicted return.
#'
#' @importFrom dplyr filter select
#'
#' @export
#'
#' @examples
#' # Define sample data
#' data_subset <- tibble::tibble(
#'   stock_id = rep(1:3, each = 10),
#'   date = rep(seq(as.Date("2020-01-01"), by = "month", length.out = 10), 3),
#'   return_label = rnorm(30),
#'   feature1 = rnorm(30),
#'   feature2 = rnorm(30)
#' )
#'
#' # Define sample indices
#' indices <- list(
#'   training_start = rep(as.Date("2020-01-01"), 3),
#'   training_end = rep(as.Date("2020-06-01"), 3),
#'   prediction_start = rep(as.Date("2020-07-01"), 3),
#'   prediction_end = rep(as.Date("2020-10-01"), 3)
#' )
#'
#' # Define sample model function and config
#' sample_model_function <- function(train_data, test_data, model_config) {
#'   test_data$pred_return <- runif(nrow(test_data))  # Random predictions for example
#'   return(test_data)
#' }
#' model_function <- "sample_model_function"
#' model_config <- list()
#'
#' # Use retpred_map
#' predictions <- retpred_map(1, data_subset, indices, model_function, model_config)
#' print(predictions)
retpred_map <- function(t, data_subset, indices, model_function, model_config) {
  # Set training and test data
  train_data <- data_subset |> 
    dplyr::filter(date >= indices$training_start[t], date <= indices$training_end[t])  # Training set
  
  test_data <- data_subset |> 
    dplyr::filter(date >= indices$prediction_start[t], date < indices$prediction_end[t]) |> 
    dplyr::select(-3)  # Test set
  
  # Invoke training function
  training_function <- match.fun(model_function)
  predictions <- training_function(train_data, test_data, model_config)
  
  return(predictions)
}

```

